<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MCP Broker â€” Dashboard</title>
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    /* â”€â”€ Design tokens aligned with Ideas dashboard â”€â”€ */
    --bg-base:     #0a0e17;
    --bg-surface:  #111827;
    --bg-elevated: #1a2236;
    --bg-hover:    #1e293b;
    --accent:      #63b3ed;
    --accent-dim:  rgba(99,179,237,0.15);
    --accent-glow: rgba(99,179,237,0.25);
    --accent-bright: #90cdf4;
    --success:     #68d391;
    --success-dim: rgba(104,211,145,0.15);
    --danger:      #fc8181;
    --danger-dim:  rgba(252,129,129,0.15);
    --warning:     #f6ad55;
    --warning-dim: rgba(246,173,85,0.15);
    --purple:      #b794f6;
    --purple-dim:  rgba(183,148,246,0.15);
    --cyan:        #76e4f7;
    --cyan-dim:    rgba(118,228,247,0.15);
    --yellow:      #fbd38d;
    --yellow-dim:  rgba(251,211,141,0.15);
    --text-primary:   #e2e8f0;
    --text-secondary: #a0aec0;
    --text-muted:     #4a5568;
    --border:      rgba(255,255,255,0.06);
    --border-focus: rgba(99,179,237,0.4);
    --glass-bg:    rgba(17,24,39,0.6);
    --glass-border: rgba(255,255,255,0.08);
    --sidebar-width: 260px;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --tr-fast:  150ms cubic-bezier(.4,0,.2,1);
    --tr-smooth: 250ms cubic-bezier(.4,0,.2,1);
  }

  @keyframes fade-in { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }
  @keyframes slide-in { from { transform:translateX(100%); } to { transform:translateX(0); } }
  @keyframes glow-pulse { 0%,100% { box-shadow: 0 0 4px currentColor; } 50% { box-shadow: 0 0 12px currentColor, 0 0 24px currentColor; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

  body {
    width: 100%; min-height: 100vh;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 13px; background: var(--bg-base); color: var(--text-primary);
    display: flex; overflow: hidden; -webkit-font-smoothing: antialiased;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sidebar {
    width: var(--sidebar-width); height: 100vh;
    background: var(--bg-surface); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0;
    position: fixed; left: 0; top: 0; z-index: 100; overflow: hidden;
  }

  .sidebar-header {
    padding: 18px 16px 14px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .sidebar-brand {
    display: flex; align-items: center; gap: 12px;
  }

  .sidebar-logo {
    width: 36px; height: 36px; border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
    box-shadow: 0 2px 12px rgba(99,179,237,0.3);
  }

  .sidebar-title {
    font-size: 15px; font-weight: 700; color: var(--text-primary);
    letter-spacing: -0.3px;
  }

  .sidebar-subtitle {
    font-size: 10px; color: var(--text-muted); margin-top: 2px;
    text-transform: uppercase; letter-spacing: .5px;
  }

  /* â”€â”€ Connection Status â”€â”€ */
  .sidebar-connection {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    display: flex; align-items: center; gap: 10px;
  }

  .connection-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--danger);
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .connection-dot.connected {
    background: var(--success);
    animation: glow-pulse 2s ease-in-out infinite;
    color: var(--success);
  }

  .connection-label {
    font-size: 12px; color: var(--text-secondary);
  }

  .connection-label .status-text {
    font-weight: 600;
  }

  /* â”€â”€ Stats Grid â”€â”€ */
  .sidebar-stats {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }

  .stat-card {
    background: var(--bg-elevated);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-sm);
    padding: 8px 10px;
    text-align: center;
    transition: var(--tr-fast);
  }

  .stat-card:hover {
    border-color: var(--border-focus);
    background: var(--bg-hover);
  }

  .stat-card .stat-num {
    font-size: 20px; font-weight: 700;
    font-variant-numeric: tabular-nums;
    line-height: 1.2;
  }

  .stat-card .stat-lbl {
    font-size: 9px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: .5px;
    margin-top: 2px;
  }

  .stat-num.c-accent  { color: var(--accent); }
  .stat-num.c-success { color: var(--success); }
  .stat-num.c-cyan    { color: var(--cyan); }
  .stat-num.c-yellow  { color: var(--yellow); }
  .stat-num.c-purple  { color: var(--purple); }
  .stat-num.c-danger  { color: var(--danger); }

  /* â”€â”€ Broker Tools Quick Panel â”€â”€ */
  .broker-tools {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .broker-tools-label {
    font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
    color: var(--text-muted); padding: 0 4px 8px;
  }

  .bt-panels {
    display: flex; flex-direction: column; gap: 6px;
  }

  .bt-panel {
    background: var(--bg-elevated);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    transition: var(--tr-fast);
  }

  .bt-panel:hover { border-color: var(--border-focus); }

  .bt-panel-header {
    padding: 6px 10px;
    display: flex; align-items: center; gap: 8px;
    cursor: pointer; user-select: none;
    transition: var(--tr-fast);
  }

  .bt-panel-header:hover { background: var(--bg-hover); }

  .bt-panel-icon { font-size: 12px; flex-shrink: 0; }
  .bt-panel-name { font-size: 11px; font-weight: 600; color: var(--text-primary); }

  .bt-panel-timing {
    margin-left: auto; font-size: 10px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    color: var(--text-muted); font-variant-numeric: tabular-nums;
  }

  .bt-panel-timing.success { color: var(--success); }
  .bt-panel-timing.error { color: var(--danger); }
  .bt-panel-timing.running { color: var(--warning); animation: pulse 1s infinite; }

  .bt-panel-body {
    display: none; padding: 8px 10px;
    border-top: 1px solid var(--border);
  }

  .bt-panel.open .bt-panel-body { display: block; }

  .bt-input-row {
    display: flex; gap: 6px; align-items: stretch;
  }

  .bt-input {
    flex: 1; background: var(--bg-base); border: 1px solid var(--border);
    border-radius: 4px; padding: 6px 10px;
    color: var(--text-primary); font-size: 11px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    outline: none; transition: var(--tr-fast);
  }

  .bt-input:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px var(--accent-dim);
  }

  .bt-input::placeholder { color: var(--text-muted); opacity: 0.5; }

  textarea.bt-input {
    min-height: 48px; resize: vertical; line-height: 1.4;
  }

  .bt-btn {
    background: linear-gradient(135deg, var(--accent) 0%, #805ad5 100%);
    color: #fff; border: none;
    padding: 6px 12px; border-radius: 4px;
    font-size: 11px; font-weight: 600; cursor: pointer;
    transition: var(--tr-fast); font-family: inherit;
    white-space: nowrap; flex-shrink: 0;
  }

  .bt-btn:hover { transform: translateY(-1px); }
  .bt-btn:active { transform: translateY(0); }
  .bt-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .bt-result {
    margin-top: 6px; padding: 6px 8px;
    background: var(--bg-base); border: 1px solid var(--glass-border);
    border-radius: 4px; font-size: 11px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    color: var(--text-secondary); line-height: 1.4;
    max-height: 80px; overflow-y: auto;
    white-space: pre-wrap; word-break: break-word;
    display: none;
  }

  .bt-result.visible { display: block; animation: fade-in 0.15s ease-out; }
  .bt-result.error { color: var(--danger); border-color: var(--danger-dim); }

  .bt-options {
    display: flex; gap: 6px; margin-top: 6px; align-items: center;
  }

  .bt-option-label {
    font-size: 10px; color: var(--text-muted);
  }

  .bt-option-input {
    background: var(--bg-base); border: 1px solid var(--border);
    border-radius: 4px; padding: 4px 8px;
    color: var(--text-primary); font-size: 10px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    outline: none; width: 80px;
  }

  .bt-option-check {
    accent-color: var(--accent); width: 13px; height: 13px; cursor: pointer;
  }

  /* â”€â”€ Search â”€â”€ */
  .sidebar-search {
    padding: 10px 16px 8px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .sidebar-search input {
    width: 100%; padding: 7px 10px 7px 30px;
    background: var(--bg-elevated); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text-primary);
    font-size: 12px; font-family: inherit; outline: none;
    transition: var(--tr-fast);
  }

  .sidebar-search input:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px var(--accent-dim);
  }

  .search-wrapper {
    position: relative;
  }

  .search-icon {
    position: absolute; left: 9px; top: 50%; transform: translateY(-50%);
    font-size: 12px; color: var(--text-muted); pointer-events: none;
  }

  /* â”€â”€ Tool Tree (in sidebar) â”€â”€ */
  .sidebar-nav {
    flex: 1; overflow-y: auto; padding: 4px 0;
  }

  .sidebar-nav::-webkit-scrollbar { width: 3px; }
  .sidebar-nav::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }

  .nav-section-label {
    font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
    color: var(--text-muted); padding: 12px 16px 4px;
  }

  .tree-client {
    border-bottom: 1px solid var(--border);
  }

  .tree-client-header {
    padding: 10px 16px;
    display: flex; align-items: center; gap: 8px;
    cursor: pointer; transition: var(--tr-fast);
    user-select: none;
  }

  .tree-client-header:hover { background: var(--bg-hover); }

  .tree-toggle {
    font-size: 10px; color: var(--text-muted);
    width: 14px; text-align: center;
    transition: transform 0.2s ease; flex-shrink: 0;
  }

  .tree-toggle.open { transform: rotate(90deg); }

  .tree-client-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--success); flex-shrink: 0;
  }

  .tree-client-name {
    font-weight: 600; font-size: 12px; color: var(--cyan);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .tree-client-count {
    font-size: 10px; color: var(--text-muted); margin-left: auto;
    background: var(--bg-elevated); padding: 1px 6px;
    border-radius: 10px; font-weight: 600; flex-shrink: 0;
  }

  .tree-client-link {
    font-size: 11px; color: var(--accent); text-decoration: none;
    padding: 2px 6px; border-radius: 4px;
    transition: var(--tr-fast); flex-shrink: 0;
    opacity: 0;
  }

  .tree-client-header:hover .tree-client-link { opacity: 1; }
  .tree-client-link:hover { background: var(--accent-dim); color: #fff; }

  .tree-tools { display: none; }
  .tree-tools.open { display: block; }

  .tree-tool {
    padding: 7px 16px 7px 40px;
    font-size: 12px; cursor: pointer;
    transition: var(--tr-fast);
    display: flex; align-items: center; gap: 8px;
    color: var(--text-secondary);
    border-left: 2px solid transparent;
  }

  .tree-tool:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  .tree-tool.selected {
    background: var(--accent-dim);
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 600;
  }

  .tree-tool-icon {
    color: var(--text-muted); font-size: 11px; flex-shrink: 0;
    transition: color var(--tr-fast);
  }

  .tree-tool.selected .tree-tool-icon { color: var(--accent); }
  .tree-tool:hover .tree-tool-icon { color: var(--text-secondary); }

  .tree-tool-name {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 11px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    flex: 1;
  }

  .tree-tool-activity {
    font-size: 10px; cursor: pointer; flex-shrink: 0;
    opacity: 0.3; transition: opacity var(--tr-fast);
    padding: 2px 4px; border-radius: 3px;
    line-height: 1;
  }
  .tree-tool-activity:hover { opacity: 0.7; }
  .tree-tool-activity.on { opacity: 1; color: var(--green); }
  .tree-tool:hover .tree-tool-activity { opacity: 0.6; }
  .tree-tool:hover .tree-tool-activity.on { opacity: 1; }

  .activity-toggle-row {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 0 2px; margin-bottom: 4px;
    font-size: 12px; color: var(--text-secondary);
    cursor: pointer; user-select: none;
  }
  .activity-toggle-row:hover { color: var(--text-primary); }
  .activity-toggle-check {
    width: 14px; height: 14px; border-radius: 3px;
    border: 1px solid var(--border); display: inline-flex;
    align-items: center; justify-content: center;
    font-size: 10px; transition: var(--tr-fast);
    background: transparent;
  }
  .activity-toggle-check.on {
    background: var(--green); border-color: var(--green); color: #000;
  }

  .sidebar-footer {
    padding: 10px 16px; border-top: 1px solid var(--border); flex-shrink: 0;
    font-size: 10px; color: var(--text-muted); text-align: center;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }

  .sidebar-footer .uptime-badge {
    color: var(--accent); font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .empty-state {
    padding: 30px 20px; text-align: center;
    color: var(--text-muted); font-size: 12px;
  }

  .empty-state .icon { font-size: 32px; margin-bottom: 10px; opacity: 0.5; }
  .empty-state .msg { font-size: 13px; line-height: 1.5; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN CONTENT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .main {
    flex: 1; margin-left: var(--sidebar-width);
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }

  /* â”€â”€ Topbar â”€â”€ */
  .topbar {
    height: 48px; background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; flex-shrink: 0;
  }

  .topbar-left { display: flex; align-items: center; gap: 12px; }

  .topbar-title {
    font-size: 14px; font-weight: 700; color: var(--text-primary);
  }

  .topbar-breadcrumb {
    font-size: 11px; color: var(--text-muted);
    display: flex; align-items: center; gap: 6px;
  }

  .topbar-breadcrumb .sep { color: var(--text-muted); opacity: 0.5; }

  .topbar-breadcrumb .client-name { color: var(--cyan); font-weight: 500; }

  .topbar-right { display: flex; align-items: center; gap: 10px; }

  .topbar-stat {
    display: flex; align-items: center; gap: 4px;
    font-size: 11px; color: var(--text-muted);
  }

  .topbar-stat .num { font-weight: 700; color: var(--text-secondary); }

  /* â”€â”€ Content Grid (interaction + activity) â”€â”€ */
  .content-grid {
    flex: 1; display: grid;
    grid-template-columns: 1fr 340px;
    min-height: 0;
  }

  @media (max-width: 1100px) {
    .content-grid { grid-template-columns: 1fr; }
    .activity-panel { display: none; }
  }

  @media (max-width: 900px) {
    .sidebar { display: none; }
    .main { margin-left: 0; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INTERACTION PANEL (center)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .interaction-panel {
    display: flex; flex-direction: column; min-height: 0;
    border-right: 1px solid var(--border);
  }

  .interaction-body {
    flex: 1; overflow-y: auto;
    display: flex; flex-direction: column;
  }

  .interaction-body::-webkit-scrollbar { width: 4px; }
  .interaction-body::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }

  /* â”€â”€ Welcome State â”€â”€ */
  .tool-welcome {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--text-muted); gap: 12px; padding: 40px;
  }

  .tool-welcome .icon {
    font-size: 56px; opacity: 0.3;
    filter: grayscale(0.5);
  }

  .tool-welcome .msg {
    font-size: 14px; line-height: 1.6; text-align: center;
    max-width: 300px;
  }

  .tool-welcome .hint {
    font-size: 11px; color: var(--text-muted); opacity: 0.6;
    margin-top: 4px;
  }

  /* â”€â”€ Tool Description â”€â”€ */
  .tool-desc {
    padding: 16px 24px;
    font-size: 13px; color: var(--text-secondary);
    border-bottom: 1px solid var(--border);
    line-height: 1.6;
    background: var(--bg-elevated);
    border-left: 3px solid var(--accent);
    margin: 16px 20px 0;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }

  /* â”€â”€ Form â”€â”€ */
  .tool-form {
    padding: 20px 24px;
    display: flex; flex-direction: column; gap: 16px;
  }

  .form-field {
    display: flex; flex-direction: column; gap: 6px;
    animation: fade-in 0.2s ease-out;
  }

  .form-label {
    font-size: 12px; font-weight: 600; color: var(--text-primary);
    display: flex; align-items: center; gap: 8px;
  }

  .form-label .type-tag {
    font-size: 10px; font-weight: 400; color: var(--text-muted);
    background: var(--bg-elevated); padding: 2px 8px;
    border-radius: 4px; font-family: 'Cascadia Code', 'Fira Code', monospace;
    border: 1px solid var(--glass-border);
  }

  .form-label .required-tag {
    font-size: 10px; font-weight: 600;
    color: var(--warning); letter-spacing: 0.3px;
  }

  .form-hint {
    font-size: 11px; color: var(--text-muted); line-height: 1.5;
  }

  .form-input {
    background: var(--bg-base); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 10px 14px;
    color: var(--text-primary); font-size: 13px;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    outline: none; transition: var(--tr-smooth);
  }

  .form-input:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px var(--accent-dim);
  }

  .form-input::placeholder { color: var(--text-muted); opacity: 0.6; }

  textarea.form-input {
    min-height: 80px; resize: vertical; line-height: 1.5;
  }

  select.form-input { cursor: pointer; }

  .form-checkbox-row {
    display: flex; align-items: center; gap: 10px; padding: 4px 0;
    cursor: pointer;
  }

  .form-checkbox-row input[type="checkbox"] {
    accent-color: var(--accent); width: 16px; height: 16px;
    cursor: pointer;
  }

  .form-checkbox-row label {
    font-size: 12px; color: var(--text-secondary); cursor: pointer;
  }

  /* â”€â”€ Form Actions â”€â”€ */
  .form-actions {
    display: flex; gap: 10px;
    padding: 14px 24px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg-surface);
  }

  .btn-run {
    background: linear-gradient(135deg, var(--accent) 0%, #805ad5 100%);
    color: #fff; border: none;
    padding: 10px 24px; border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 600; cursor: pointer;
    transition: var(--tr-smooth); font-family: inherit;
    box-shadow: 0 2px 8px rgba(99,179,237,0.25);
  }

  .btn-run:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(99,179,237,0.35);
  }

  .btn-run:active { transform: translateY(0); }

  .btn-run:disabled {
    opacity: 0.4; cursor: not-allowed;
    transform: none; box-shadow: none;
  }

  .btn-clear-form {
    background: var(--bg-elevated);
    border: 1px solid var(--glass-border);
    color: var(--text-secondary); padding: 10px 18px;
    border-radius: var(--radius-sm); font-size: 13px;
    cursor: pointer; transition: var(--tr-fast); font-family: inherit;
  }

  .btn-clear-form:hover {
    background: var(--bg-hover); color: var(--text-primary);
    border-color: var(--border-focus);
  }

  /* â”€â”€ Result Area â”€â”€ */
  .result-area {
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    animation: fade-in 0.2s ease-out;
  }

  .result-header {
    padding: 12px 24px;
    font-size: 12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.6px;
    color: var(--text-muted);
    display: flex; align-items: center; gap: 10px;
    background: var(--bg-surface);
  }

  .result-timing {
    font-weight: 400; font-size: 11px; color: var(--text-muted);
    font-variant-numeric: tabular-nums;
  }

  .result-status {
    font-size: 10px; font-weight: 700; padding: 3px 10px;
    border-radius: 10px; letter-spacing: 0.3px;
  }

  .result-status.success { background: var(--success-dim); color: var(--success); }
  .result-status.error   { background: var(--danger-dim); color: var(--danger); }

  .result-body {
    padding: 16px 24px; max-height: 300px; overflow-y: auto;
  }

  .result-body::-webkit-scrollbar { width: 4px; }
  .result-body::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }

  .result-body pre {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 12px; line-height: 1.6;
    white-space: pre-wrap; word-break: break-word;
    color: var(--text-secondary);
    background: var(--bg-base); border: 1px solid var(--glass-border);
    border-radius: var(--radius-sm); padding: 14px;
  }

  .result-body pre.error-text {
    color: var(--danger);
    border-color: var(--danger-dim);
    background: rgba(252,129,129,0.05);
  }

  /* â”€â”€ Spinner â”€â”€ */
  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid var(--glass-border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ACTIVITY PANEL (right)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .activity-panel {
    border-left: 1px solid var(--border);
    display: flex; flex-direction: column; min-height: 0;
    background: var(--bg-surface);
  }

  .activity-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 12px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.6px;
    color: var(--text-muted);
    display: flex; align-items: center; gap: 8px;
    flex-shrink: 0;
  }

  .panel-badge {
    background: var(--accent-dim); color: var(--accent);
    font-size: 10px; font-weight: 700;
    padding: 2px 8px; border-radius: 10px;
  }

  .activity-actions {
    margin-left: auto; display: flex; gap: 6px;
  }

  .activity-body {
    overflow-y: auto; flex: 1;
  }

  .activity-body::-webkit-scrollbar { width: 3px; }
  .activity-body::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }

  .activity-item {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: flex-start; gap: 10px;
    font-size: 12px; transition: var(--tr-fast);
    animation: fade-in 0.15s ease-out;
  }

  .activity-item:last-child { border-bottom: none; }
  .activity-item:hover { background: var(--bg-hover); }

  .activity-time {
    color: var(--text-muted);
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 10px; flex-shrink: 0; min-width: 60px;
    padding-top: 1px;
    font-variant-numeric: tabular-nums;
  }

  .activity-icon {
    flex-shrink: 0; width: 16px; text-align: center;
    font-size: 12px;
  }

  .activity-msg {
    color: var(--text-secondary); word-break: break-word;
    line-height: 1.5;
  }

  .activity-msg code {
    background: var(--bg-elevated); padding: 1px 6px;
    border-radius: 3px;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 11px; color: var(--accent);
  }

  /* â”€â”€ Buttons â”€â”€ */
  .btn-sm {
    background: var(--bg-elevated);
    border: 1px solid var(--glass-border);
    color: var(--text-muted); font-size: 10px;
    padding: 4px 10px; border-radius: var(--radius-sm);
    cursor: pointer; transition: var(--tr-fast);
    font-family: inherit;
  }

  .btn-sm:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    border-color: var(--border-focus);
  }

  /* â”€â”€ Scrollbar global â”€â”€ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 900px) {
    .sidebar { display: none; }
    .main { margin-left: 0; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">
      <div class="sidebar-logo">âš¡</div>
      <div>
        <div class="sidebar-title">MCP Broker</div>
        <div class="sidebar-subtitle">Tool Orchestration Hub</div>
      </div>
    </div>
  </div>

  <div class="sidebar-connection">
    <div id="sse-dot" class="connection-dot"></div>
    <div class="connection-label">
      <span id="sse-label" class="status-text">Connectingâ€¦</span>
    </div>
  </div>

  <div class="sidebar-stats">
    <div class="stat-card">
      <div class="stat-num c-success" id="stat-clients">0</div>
      <div class="stat-lbl">Clients</div>
    </div>
    <div class="stat-card">
      <div class="stat-num c-cyan" id="stat-tools">0</div>
      <div class="stat-lbl">Tools</div>
    </div>
    <div class="stat-card">
      <div class="stat-num c-yellow" id="stat-tool-calls">0</div>
      <div class="stat-lbl">Calls</div>
    </div>
    <div class="stat-card">
      <div class="stat-num c-purple" id="stat-chat">0</div>
      <div class="stat-lbl">Chat</div>
    </div>
    <div class="stat-card">
      <div class="stat-num c-accent" id="stat-total-conn">0</div>
      <div class="stat-lbl">Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-num c-danger" id="stat-errors">0</div>
      <div class="stat-lbl">Errors</div>
    </div>
  </div>

  <div class="broker-tools">
    <div class="broker-tools-label">Broker Tools</div>
    <div class="bt-panels">
      <!-- Speak -->
      <div class="bt-panel" id="bt-speak">
        <div class="bt-panel-header" onclick="btToggle('bt-speak')">
          <span class="bt-panel-icon">ğŸ”Š</span>
          <span class="bt-panel-name">Speak</span>
          <span class="bt-panel-timing" id="bt-speak-timing"></span>
        </div>
        <div class="bt-panel-body">
          <div class="bt-input-row">
            <input class="bt-input" id="bt-speak-text" type="text" placeholder="Text to speakâ€¦" onkeydown="if(event.key==='Enter')btSpeak()">
            <button class="bt-btn" id="bt-speak-btn" onclick="btSpeak()">â–¶</button>
          </div>
          <div class="bt-result" id="bt-speak-result"></div>
        </div>
      </div>
      <!-- Ask AI -->
      <div class="bt-panel" id="bt-ask">
        <div class="bt-panel-header" onclick="btToggle('bt-ask')">
          <span class="bt-panel-icon">ğŸ¤–</span>
          <span class="bt-panel-name">Ask AI</span>
          <span class="bt-panel-timing" id="bt-ask-timing"></span>
        </div>
        <div class="bt-panel-body">
          <div class="bt-input-row">
            <input class="bt-input" id="bt-ask-prompt" type="text" placeholder="Ask a questionâ€¦" onkeydown="if(event.key==='Enter')btAsk()">
            <button class="bt-btn" id="bt-ask-btn" onclick="btAsk()">â–¶</button>
          </div>
          <div class="bt-options">
            <input type="checkbox" class="bt-option-check" id="bt-ask-speak">
            <label class="bt-option-label" for="bt-ask-speak">Speak</label>
            <span class="bt-option-label" style="margin-left:auto">Model:</span>
            <input class="bt-option-input" id="bt-ask-model" type="text" placeholder="default">
          </div>
          <div class="bt-result" id="bt-ask-result"></div>
        </div>
      </div>
      <!-- Chat -->
      <div class="bt-panel" id="bt-chat">
        <div class="bt-panel-header" onclick="btToggle('bt-chat')">
          <span class="bt-panel-icon">ğŸ’¬</span>
          <span class="bt-panel-name">Chat</span>
          <span class="bt-panel-timing" id="bt-chat-timing"></span>
        </div>
        <div class="bt-panel-body">
          <div class="bt-input-row">
            <input class="bt-input" id="bt-chat-msg" type="text" placeholder="Send a messageâ€¦" onkeydown="if(event.key==='Enter')btChat()">
            <button class="bt-btn" id="bt-chat-btn" onclick="btChat()">â–¶</button>
          </div>
          <div class="bt-options">
            <span class="bt-option-label">Model:</span>
            <input class="bt-option-input" id="bt-chat-model" type="text" placeholder="default">
          </div>
          <div class="bt-result" id="bt-chat-result"></div>
        </div>
      </div>
      <!-- Clients -->
      <div class="bt-panel" id="bt-clients">
        <div class="bt-panel-header" onclick="btToggle('bt-clients')">
          <span class="bt-panel-icon">ğŸ“‹</span>
          <span class="bt-panel-name">Clients</span>
          <span class="bt-panel-timing" id="bt-clients-timing"></span>
        </div>
        <div class="bt-panel-body">
          <div class="bt-input-row">
            <button class="bt-btn" onclick="btClients()" style="width:100%">List Connected Clients</button>
          </div>
          <div class="bt-result" id="bt-clients-result"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar-search">
    <div class="search-wrapper">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="toolSearch" placeholder="Filter toolsâ€¦" autocomplete="off">
    </div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section-label">Connected Clients</div>
    <div id="explorer-body">
      <div class="empty-state">
        <div class="icon">ğŸ“¡</div>
        <div class="msg">No broker-clients connected</div>
      </div>
    </div>
  </nav>

  <div class="sidebar-footer">
    Uptime: <span class="uptime-badge" id="stat-uptime">â€”</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title" id="topbar-title">Tool Workbench</span>
      <span class="topbar-breadcrumb" id="topbar-breadcrumb"></span>
    </div>
    <div class="topbar-right">
      <div class="topbar-stat">
        <span id="stat-tool-errors" style="color:var(--danger)"></span>
      </div>
      <div class="topbar-stat">
        <span id="stat-chat-errors" style="color:var(--danger)"></span>
      </div>
    </div>
  </div>

  <div class="content-grid">
    <!-- Center: Interaction Panel -->
    <div class="interaction-panel">
      <div class="interaction-body" id="interaction-body">
        <div class="tool-welcome" id="tool-welcome">
          <div class="icon">âš¡</div>
          <div class="msg">Select a tool from the sidebar to begin</div>
          <div class="hint">Browse connected clients and their tools in the left panel</div>
        </div>
      </div>
      <div class="form-actions" id="form-actions" style="display:none;">
        <button class="btn-run" id="btn-run" onclick="runTool()">â–¶ Run Tool</button>
        <button class="btn-clear-form" onclick="clearForm()">Clear</button>
      </div>
      <div class="result-area" id="result-area" style="display:none;">
        <div class="result-header" id="result-header"></div>
        <div class="result-body" id="result-body"></div>
      </div>
    </div>

    <!-- Right: Activity Log -->
    <div class="activity-panel">
      <div class="activity-header">
        Activity
        <span class="panel-badge" id="activity-badge">0</span>
        <div class="activity-actions">
          <button class="btn-sm" onclick="toggleAutoScroll()"><span id="autoscroll-label">Auto</span></button>
          <button class="btn-sm" onclick="clearLog()">Clear</button>
        </div>
      </div>
      <div class="activity-body" id="activity-body">
        <div class="empty-state">
          <div class="icon">ğŸ“‹</div>
          <div class="msg">No activity yet</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // â”€â”€ State â”€â”€
  let autoScroll = true;
  let activityCount = 0;
  let displayedActivities = [];
  let currentClients = [];
  let selectedTool = null; // { clientId, name, description, inputSchema }

  // â”€â”€ Activity Filter (per-tool opt-in) â”€â”€
  const ACTIVITY_STORAGE_KEY = 'broker-activity-enabled';
  let activityEnabled = new Set(JSON.parse(localStorage.getItem(ACTIVITY_STORAGE_KEY) || '[]'));

  function activityKey(clientId, toolName) { return clientId + '__' + toolName; }

  function isActivityEnabled(clientId, toolName) {
    return activityEnabled.has(activityKey(clientId, toolName));
  }

  function toggleActivity(clientId, toolName) {
    const key = activityKey(clientId, toolName);
    if (activityEnabled.has(key)) activityEnabled.delete(key);
    else activityEnabled.add(key);
    localStorage.setItem(ACTIVITY_STORAGE_KEY, JSON.stringify([...activityEnabled]));
    renderExplorer(currentClients);
    // Update tool card toggle if this tool is selected
    if (selectedTool && selectedTool.clientId === clientId && selectedTool.name === toolName) {
      updateToolCardActivityToggle();
    }
  }

  function shouldShowActivity(entry) {
    // Always show non-tool events (connect, disconnect) and events without tool data
    if (!entry.data || !entry.data.tool) return true;
    // For tool events, check if that tool's activity is enabled
    const clientId = entry.data.clientId || 'broker';
    return activityEnabled.has(activityKey(clientId, entry.data.tool));
  }

  // â”€â”€ Elements â”€â”€
  const $ = (id) => document.getElementById(id);
  const $sseDot = $('sse-dot');
  const $sseLabel = $('sse-label');
  const $statUptime = $('stat-uptime');
  const $statClients = $('stat-clients');
  const $statTools = $('stat-tools');
  const $statToolCalls = $('stat-tool-calls');
  const $statToolErrors = $('stat-tool-errors');
  const $statChat = $('stat-chat');
  const $statChatErrors = $('stat-chat-errors');
  const $statTotalConn = $('stat-total-conn');
  const $statErrors = $('stat-errors');
  const $explorerBody = $('explorer-body');
  const $interactionBody = $('interaction-body');
  const $formActions = $('form-actions');
  const $resultArea = $('result-area');
  const $resultHeader = $('result-header');
  const $resultBody = $('result-body');
  const $activityBadge = $('activity-badge');
  const $activityBody = $('activity-body');
  const $topbarTitle = $('topbar-title');
  const $topbarBreadcrumb = $('topbar-breadcrumb');

  // â”€â”€ Formatters â”€â”€
  function formatUptime(ms) {
    const s = Math.floor(ms / 1000);
    if (s < 60) return s + 's';
    const m = Math.floor(s / 60);
    if (m < 60) return m + 'm ' + (s % 60) + 's';
    const h = Math.floor(m / 60);
    if (h < 24) return h + 'h ' + (m % 60) + 'm';
    const d = Math.floor(h / 24);
    return d + 'd ' + (h % 24) + 'h';
  }

  function formatTime(isoStr) {
    const d = new Date(isoStr);
    return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  const ACTIVITY_ICONS = {
    connect: 'ğŸŸ¢', disconnect: 'ğŸ”´', tool_call: 'ğŸ”§', tool_result: 'âœ…',
    tool_error: 'âŒ', chat: 'ğŸ’¬', chat_error: 'âš ï¸', notification: 'ğŸ””'
  };

  // â”€â”€ Stats â”€â”€
  let lastUptime = 0;

  function updateStats(state) {
    lastUptime = state.uptime;
    $statClients.textContent = state.connectedClients;
    $statTools.textContent = state.totalTools;
    $statToolCalls.textContent = state.stats.toolCalls;
    $statToolErrors.textContent = state.stats.toolErrors > 0 ? state.stats.toolErrors + ' err' : '';
    $statChat.textContent = state.stats.chatRequests;
    $statChatErrors.textContent = state.stats.chatErrors > 0 ? state.stats.chatErrors + ' err' : '';
    $statTotalConn.textContent = state.stats.totalConnections;
    $statErrors.textContent = (state.stats.toolErrors || 0) + (state.stats.chatErrors || 0);
  }

  setInterval(() => {
    if (lastUptime > 0) {
      lastUptime += 1000;
      $statUptime.textContent = formatUptime(lastUptime);
    }
  }, 1000);

  // â”€â”€ Escape â”€â”€
  function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function escMsg(str) {
    let safe = esc(str);
    safe = safe.replace(/&quot;([^&]+)&quot;/g, '<code>$1</code>');
    return safe;
  }

  // â”€â”€ Tool Search Filter â”€â”€
  let toolSearchQuery = '';
  const $toolSearch = $('toolSearch');
  if ($toolSearch) {
    $toolSearch.addEventListener('input', (e) => {
      toolSearchQuery = e.target.value.trim().toLowerCase();
      renderExplorer(currentClients);
    });
  }

  // â”€â”€ Tool Explorer (hierarchy in sidebar) â”€â”€
  let expandedClients = new Set();

  function renderExplorer(clients) {
    currentClients = clients;

    if (clients.length === 0) {
      $explorerBody.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“¡</div><div class="msg">No broker-clients connected</div></div>';
      return;
    }

    $explorerBody.innerHTML = clients.map(c => {
      const isOpen = expandedClients.has(c.clientId);

      // Filter tools by search query
      const filteredTools = toolSearchQuery
        ? c.tools.filter(t => t.name.toLowerCase().includes(toolSearchQuery) || (t.description || '').toLowerCase().includes(toolSearchQuery))
        : c.tools;

      // If searching and no tools match, skip this client
      if (toolSearchQuery && filteredTools.length === 0) return '';

      return `
        <div class="tree-client">
          <div class="tree-client-header" data-client="${esc(c.clientId)}">
            <span class="tree-toggle ${isOpen ? 'open' : ''}">â–¶</span>
            <span class="tree-client-dot"></span>
            <span class="tree-client-name">${esc(c.clientId)}</span>
            <span class="tree-client-count">${filteredTools.length}</span>
            <a class="tree-client-link" href="/client/${encodeURIComponent(c.clientId)}" target="_blank" title="Open ${esc(c.clientId)} dashboard" onclick="event.stopPropagation()">â†—</a>
          </div>
          <div class="tree-tools ${isOpen || toolSearchQuery ? 'open' : ''}">
            ${filteredTools.map(t => {
              const isSel = selectedTool && selectedTool.clientId === c.clientId && selectedTool.name === t.name;
              const actOn = isActivityEnabled(c.clientId, t.name);
              return `<div class="tree-tool ${isSel ? 'selected' : ''}" data-client="${esc(c.clientId)}" data-tool="${esc(t.name)}">
                <span class="tree-tool-icon">âš¡</span>
                <span class="tree-tool-name">${esc(t.name)}</span>
                <span class="tree-tool-activity ${actOn ? 'on' : ''}" data-act-client="${esc(c.clientId)}" data-act-tool="${esc(t.name)}" title="${actOn ? 'Activity ON â€” click to disable' : 'Activity OFF â€” click to enable'}">${actOn ? 'ğŸ“¡' : 'â—‹'}</span>
              </div>`;
            }).join('')}
          </div>
        </div>`;
    }).join('');

    // Attach click handlers
    $explorerBody.querySelectorAll('.tree-client-header').forEach(el => {
      el.addEventListener('click', () => {
        const cid = el.dataset.client;
        if (expandedClients.has(cid)) expandedClients.delete(cid);
        else expandedClients.add(cid);
        renderExplorer(currentClients);
      });
    });

    $explorerBody.querySelectorAll('.tree-tool').forEach(el => {
      el.addEventListener('click', (e) => {
        // If clicking the activity toggle, don't select the tool
        if (e.target.classList.contains('tree-tool-activity')) return;
        const cid = el.dataset.client;
        const tname = el.dataset.tool;
        const client = clients.find(c => c.clientId === cid);
        const tool = client && client.tools.find(t => t.name === tname);
        if (tool) selectTool(cid, tool);
      });
    });

    // Attach activity toggle handlers
    $explorerBody.querySelectorAll('.tree-tool-activity').forEach(el => {
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleActivity(el.dataset.actClient, el.dataset.actTool);
      });
    });
  }

  // â”€â”€ Select Tool â†’ Render Interaction â”€â”€
  function selectTool(clientId, tool) {
    selectedTool = { clientId, name: tool.name, description: tool.description, inputSchema: tool.inputSchema };

    // Update sidebar selection
    $explorerBody.querySelectorAll('.tree-tool').forEach(el => {
      el.classList.toggle('selected', el.dataset.client === clientId && el.dataset.tool === tool.name);
    });

    // Update topbar
    $topbarTitle.textContent = tool.name;
    $topbarBreadcrumb.innerHTML = '<span class="sep">Â·</span> <span class="client-name">' + esc(clientId) + '</span>';

    // Build form
    const schema = tool.inputSchema || { type: 'object', properties: {} };
    const props = schema.properties || {};
    const required = new Set(schema.required || []);
    const keys = Object.keys(props);

    let html = '';
    if (tool.description) {
      html += '<div class="tool-desc">' + esc(tool.description) + '</div>';
    }

    if (keys.length === 0) {
      html += '<div class="tool-form"><div class="form-hint" style="padding:8px 0;">This tool takes no parameters.</div></div>';
    } else {
      html += '<div class="tool-form">';
      for (const key of keys) {
        const prop = props[key];
        const isReq = required.has(key);
        const type = prop.type || 'string';

        html += '<div class="form-field">';
        html += '<label class="form-label">' + esc(key);
        html += ' <span class="type-tag">' + esc(type) + '</span>';
        if (isReq) html += ' <span class="required-tag">required</span>';
        html += '</label>';

        if (prop.description) {
          html += '<div class="form-hint">' + esc(prop.description) + '</div>';
        }

        if (type === 'boolean') {
          html += '<div class="form-checkbox-row"><input type="checkbox" id="field-' + esc(key) + '" data-field="' + esc(key) + '" data-type="boolean"><label for="field-' + esc(key) + '">Enable</label></div>';
        } else if (type === 'number' || type === 'integer') {
          html += '<input class="form-input" type="number" id="field-' + esc(key) + '" data-field="' + esc(key) + '" data-type="' + esc(type) + '" placeholder="' + esc(prop.description || key) + '">';
        } else if (prop.enum) {
          html += '<select class="form-input" id="field-' + esc(key) + '" data-field="' + esc(key) + '" data-type="string">';
          html += '<option value="">â€” select â€”</option>';
          for (const v of prop.enum) {
            html += '<option value="' + esc(String(v)) + '">' + esc(String(v)) + '</option>';
          }
          html += '</select>';
        } else {
          const isLong = (prop.description || '').toLowerCase().includes('prompt') || (prop.description || '').toLowerCase().includes('text') || (prop.description || '').toLowerCase().includes('content') || key === 'prompt' || key === 'text' || key === 'content';
          if (isLong) {
            html += '<textarea class="form-input" id="field-' + esc(key) + '" data-field="' + esc(key) + '" data-type="string" placeholder="' + esc(prop.description || key) + '"></textarea>';
          } else {
            html += '<input class="form-input" type="text" id="field-' + esc(key) + '" data-field="' + esc(key) + '" data-type="string" placeholder="' + esc(prop.description || key) + '">';
          }
        }

        html += '</div>';
      }
      html += '</div>';
    }

    $interactionBody.innerHTML = html;
    $formActions.style.display = 'flex';
    $resultArea.style.display = 'none';
    $('btn-run').disabled = false;
    $('btn-run').innerHTML = 'â–¶ Run Tool';
    updateToolCardActivityToggle();
  }

  function updateToolCardActivityToggle() {
    if (!selectedTool) return;
    const existing = document.getElementById('tool-activity-toggle');
    if (existing) existing.remove();
    const on = isActivityEnabled(selectedTool.clientId, selectedTool.name);
    const row = document.createElement('div');
    row.className = 'activity-toggle-row';
    row.id = 'tool-activity-toggle';
    row.innerHTML = '<span class="activity-toggle-check ' + (on ? 'on' : '') + '">' + (on ? 'âœ“' : '') + '</span> Show Activity';
    row.addEventListener('click', () => toggleActivity(selectedTool.clientId, selectedTool.name));
    $interactionBody.insertBefore(row, $interactionBody.firstChild);
  }

  // â”€â”€ Run Tool â”€â”€
  window.runTool = async function() {
    if (!selectedTool) return;
    const btn = $('btn-run');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Runningâ€¦';

    // Gather form data
    const args = {};
    $interactionBody.querySelectorAll('[data-field]').forEach(el => {
      const key = el.dataset.field;
      const type = el.dataset.type;
      if (type === 'boolean') {
        args[key] = el.checked;
      } else if (type === 'number' || type === 'integer') {
        if (el.value !== '') args[key] = Number(el.value);
      } else {
        if (el.value !== '') args[key] = el.value;
      }
    });

    try {
      const res = await fetch('/api/call-tool', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId: selectedTool.clientId, tool: selectedTool.name, arguments: args }),
      });

      const data = await res.json();

      $resultArea.style.display = 'block';

      if (res.ok && !data.isError) {
        $resultHeader.innerHTML = 'Result <span class="result-status success">Success</span> <span class="result-timing">' + (data.duration || 0) + 'ms</span>';
        const text = (data.content || []).map(c => c.type === 'text' ? c.text : JSON.stringify(c)).join('\n');
        $resultBody.innerHTML = '<pre>' + esc(text || '(empty response)') + '</pre>';
      } else {
        $resultHeader.innerHTML = 'Result <span class="result-status error">Error</span> <span class="result-timing">' + (data.duration || 0) + 'ms</span>';
        const errText = data.error || (data.content || []).map(c => c.text || '').join('\n') || 'Unknown error';
        $resultBody.innerHTML = '<pre class="error-text">' + esc(errText) + '</pre>';
      }
    } catch (err) {
      $resultArea.style.display = 'block';
      $resultHeader.innerHTML = 'Result <span class="result-status error">Error</span>';
      $resultBody.innerHTML = '<pre class="error-text">' + esc('Network error: ' + err.message) + '</pre>';
    }

    btn.disabled = false;
    btn.innerHTML = 'â–¶ Run Tool';
  };

  window.clearForm = function() {
    $interactionBody.querySelectorAll('[data-field]').forEach(el => {
      if (el.type === 'checkbox') el.checked = false;
      else el.value = '';
    });
    $resultArea.style.display = 'none';
  };

  // â”€â”€ Activity Log â”€â”€
  function addActivityEntry(entry) {
    // Filter: only show activity for tools with activity enabled
    if (!shouldShowActivity(entry)) return;

    activityCount++;
    displayedActivities.push(entry);
    if (displayedActivities.length > 200) displayedActivities.shift();

    $activityBadge.textContent = activityCount;

    const empty = $activityBody.querySelector('.empty-state');
    if (empty) empty.remove();

    const div = document.createElement('div');
    div.className = 'activity-item';
    div.innerHTML =
      '<span class="activity-time">' + formatTime(entry.time) + '</span>' +
      '<span class="activity-icon">' + (ACTIVITY_ICONS[entry.type] || 'ğŸ“Œ') + '</span>' +
      '<span class="activity-msg">' + escMsg(entry.message) + '</span>';

    $activityBody.appendChild(div);
    while ($activityBody.children.length > 200) $activityBody.removeChild($activityBody.firstChild);
    if (autoScroll) $activityBody.scrollTop = $activityBody.scrollHeight;
  }

  function renderActivityBulk(entries) {
    $activityBody.innerHTML = '';
    displayedActivities = [];
    activityCount = 0;
    for (const entry of entries) addActivityEntry(entry);
  }

  window.toggleAutoScroll = function() {
    autoScroll = !autoScroll;
    $('autoscroll-label').textContent = autoScroll ? 'Auto' : 'Manual';
  };

  window.clearLog = function() {
    $activityBody.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><div class="msg">No activity yet</div></div>';
    displayedActivities = [];
    activityCount = 0;
    $activityBadge.textContent = '0';
  };

  // â”€â”€ Broker Tools Quick Panel â”€â”€
  window.btToggle = function(id) {
    document.getElementById(id).classList.toggle('open');
  };

  function btSetTiming(id, ms, isError) {
    const el = document.getElementById(id + '-timing');
    el.textContent = ms + 'ms';
    el.className = 'bt-panel-timing ' + (isError ? 'error' : 'success');
  }

  function btSetRunning(id) {
    const el = document.getElementById(id + '-timing');
    el.textContent = 'â€¦';
    el.className = 'bt-panel-timing running';
  }

  function btShowResult(id, text, isError) {
    const el = document.getElementById(id + '-result');
    el.textContent = text;
    el.className = 'bt-result visible' + (isError ? ' error' : '');
  }

  async function btCallTool(toolName, args) {
    const start = Date.now();
    const res = await fetch('/api/call-tool', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tool: toolName, arguments: args }),
    });
    const data = await res.json();
    const ms = Date.now() - start;
    const text = res.ok && !data.isError
      ? (data.content || []).map(c => c.type === 'text' ? c.text : JSON.stringify(c)).join('\n') || '(ok)'
      : data.error || (data.content || []).map(c => c.text || '').join('\n') || 'Unknown error';
    return { ms, text, isError: !res.ok || data.isError || false };
  }

  window.btSpeak = async function() {
    const text = $('bt-speak-text').value.trim();
    if (!text) return;
    btSetRunning('bt-speak');
    const r = await btCallTool('speak', { text });
    btSetTiming('bt-speak', r.ms, r.isError);
    btShowResult('bt-speak', r.text, r.isError);
  };

  window.btAsk = async function() {
    const prompt = $('bt-ask-prompt').value.trim();
    if (!prompt) return;
    btSetRunning('bt-ask');
    const resultEl = document.getElementById('bt-ask-result');
    resultEl.textContent = '';
    resultEl.className = 'bt-result visible';
    const body = { prompt };
    const model = $('bt-ask-model').value.trim();
    if (model) body.model = model;
    if ($('bt-ask-speak').checked) body.speak = true;
    const start = Date.now();
    try {
      const res = await fetch('/api/ask-stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buf = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += decoder.decode(value, { stream: true });
        const parts = buf.split('\n\n');
        buf = parts.pop();
        for (const part of parts) {
          if (!part.startsWith('data: ')) continue;
          const d = JSON.parse(part.slice(6));
          if (d.token) resultEl.textContent += d.token;
          if (d.error) { resultEl.textContent = d.error; resultEl.className = 'bt-result visible error'; }
        }
      }
      btSetTiming('bt-ask', Date.now() - start, false);
    } catch (err) {
      resultEl.textContent = err.message;
      resultEl.className = 'bt-result visible error';
      btSetTiming('bt-ask', Date.now() - start, true);
    }
  };

  window.btChat = async function() {
    const msg = $('bt-chat-msg').value.trim();
    if (!msg) return;
    btSetRunning('bt-chat');
    const model = $('bt-chat-model').value.trim();
    const start = Date.now();
    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg, model: model || undefined }),
      });
      const data = await res.json();
      const ms = data.duration || (Date.now() - start);
      if (res.ok) {
        btSetTiming('bt-chat', ms, false);
        btShowResult('bt-chat', data.response || '(empty)', false);
      } else {
        btSetTiming('bt-chat', ms, true);
        btShowResult('bt-chat', data.error || 'Unknown error', true);
      }
    } catch (err) {
      btSetTiming('bt-chat', Date.now() - start, true);
      btShowResult('bt-chat', 'Network error: ' + err.message, true);
    }
  };

  window.btClients = async function() {
    btSetRunning('bt-clients');
    const r = await btCallTool('list_broker_clients', {});
    btSetTiming('bt-clients', r.ms, r.isError);
    if (!r.isError) {
      try {
        const clients = JSON.parse(r.text);
        const summary = clients.map(c => c.clientId + ' (' + c.tools.length + ' tools)').join('\n');
        btShowResult('bt-clients', summary || '(no clients)', false);
      } catch { btShowResult('bt-clients', r.text, false); }
    } else {
      btShowResult('bt-clients', r.text, true);
    }
  };

  // â”€â”€ SSE â”€â”€
  function connectSSE() {
    const evtSource = new EventSource('/api/events');

    evtSource.onopen = () => {
      $sseDot.classList.add('connected');
      $sseLabel.textContent = 'Live';
    };

    evtSource.onmessage = (event) => {
      let data;
      try { data = JSON.parse(event.data); } catch { return; }

      if (data.type === 'state') {
        updateStats(data);
        renderExplorer(data.clients);
      } else if (data.type === 'activity') {
        addActivityEntry(data.entry);
      }
    };

    evtSource.onerror = () => {
      $sseDot.classList.remove('connected');
      $sseLabel.textContent = 'Reconnectingâ€¦';
    };
  }

  // â”€â”€ Init â”€â”€
  async function init() {
    try {
      const actRes = await fetch('/api/activity');
      if (actRes.ok) renderActivityBulk(await actRes.json());
    } catch {}
    connectSSE();
  }

  init();
})();
</script>
</body>
</html>
